import{r as p,c as k,d as $,q as D,o as z,s as x,b as h,k as b,e as t,w as G,f as U,v as R,t as d,m as C,T as F,g as T,x as J,y as B,p as q,F as K,i as P,n as Y,j as _,_ as X}from"./index-CblIsNI7.js";import{N as Q}from"./Navbar-DwRIBrG9.js";import{b as Z,W as O,a as tt}from"./localStorage-gGBUY11W.js";import{c as et}from"./config-DlK2M2UR.js";const W=()=>typeof window<"u",it=()=>typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,st=n=>{if(!Array.isArray(n))return;const i=a=>{if(!a||typeof a!="object")return!1;const l=a;return typeof l.id=="string"&&typeof l.userId=="string"&&typeof l.title=="string"&&typeof l.content=="string"&&typeof l.charCount=="number"&&typeof l.score=="number"&&typeof l.feedback=="string"&&typeof l.createdAt=="number"};if(n.every(i))return n},M=()=>{if(!W())return[];try{const n=localStorage.getItem(O);if(!n)return[];const i=JSON.parse(n);return st(i)??[]}catch(n){return console.error("Failed to read writing history",n),[]}},nt=n=>{if(W())try{localStorage.setItem(O,JSON.stringify(n))}catch(i){console.error("Failed to write writing history",i)}},rt=()=>{const n=Z(),i=p([]),a=()=>{if(!n){i.value=[];return}i.value=M().filter(r=>r.userId===n).sort((r,o)=>o.createdAt-r.createdAt)},l=()=>{if(!n)return;const r=M().filter(o=>o.userId!==n);nt([...i.value,...r])},u=r=>{if(!n)return;const o={id:it(),createdAt:Date.now(),userId:n,...r};return i.value=[o,...i.value],l(),o},f=(r,o)=>{const w=i.value.findIndex(S=>S.id===r);w!==-1&&(i.value.splice(w,1,{...i.value[w],...o}),l())};return a(),{submissions:k(()=>i.value),addSubmission:u,updateSubmission:f,reload:a}},ot={class:"writing-screen"},at={class:"writing-main"},lt={class:"writing-content"},ct={class:"writing-field"},dt=["disabled"],ut={class:"writing-field"},vt={class:"writing-field__header"},ht={class:"writing-counter"},_t=["disabled"],ft={class:"writing-actions"},gt=["disabled"],pt=["disabled"],mt={key:0},wt={key:1},yt={key:0,class:"writing-error"},bt=["disabled"],kt={key:0,class:"writing-result"},St={class:"writing-result__header"},It={class:"writing-result__meta"},xt={class:"writing-score"},Ct={class:"writing-result__content"},Tt={class:"writing-result__paragraph"},At={class:"writing-feedback"},Nt={class:"writing-history"},Vt=["onClick"],Et={class:"history-item__title"},Dt={class:"history-item__date"},Ut={class:"history-item__score"},Rt={key:0,class:"writing-history__empty"},Ft=2,Bt=$({__name:"WritingView",setup(n){const i=p(""),a=p(""),l=p(null),u=p(!1),f=p(""),r=p(null),{submissions:o,addSubmission:w,reload:S}=rt(),I=k(()=>a.value.trim().length),A=k(()=>I.value>0&&!u.value),v=k(()=>o.value.find(s=>s.id===r.value)??null),y=()=>{const s=l.value;s&&(s.style.height="auto",s.style.height=`${s.scrollHeight}px`)},j=()=>{y()},N=s=>new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit",year:"numeric"}).format(new Date(s)),V=()=>{i.value="",a.value="",f.value="",x(y)},H=s=>{r.value=s},L=async()=>{const s={title:i.value.trim(),content:a.value.trim()};let e=null;for(let c=0;c<Ft;c+=1)try{const m=await fetch(et("/api/evaluate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!m.ok)throw new Error(await m.text());const g=await m.json();if(typeof(g==null?void 0:g.score)=="number"&&g.score>=0&&g.score<=10&&typeof g.feedback=="string")return g;throw new Error("Invalid response format")}catch(m){e=m}throw e??new Error("Unknown error")},E=async()=>{if(A.value){u.value=!0,f.value="";try{const s=await L(),e=w({title:i.value.trim(),content:a.value.trim(),charCount:I.value,score:s.score,feedback:s.feedback});e&&(r.value=e.id,tt({type:"writing",topic:e.title||"writing",score:e.score})),V()}catch(s){console.error("Failed to evaluate writing",s),f.value="Không thể chấm điểm lúc này. Vui lòng kiểm tra kết nối và thử lại."}finally{u.value=!1,S()}}};return D(a,()=>x(y)),D(()=>o.value.length,s=>{s&&!r.value&&(r.value=o.value[0].id)},{immediate:!0}),z(()=>{x(y),o.value.length&&(r.value=o.value[0].id)}),(s,e)=>(_(),h("div",ot,[b(Q),t("main",at,[t("section",lt,[t("form",{class:"writing-card",onSubmit:G(E,["prevent"])},[e[4]||(e[4]=t("header",{class:"writing-card__header"},[t("h1",{class:"writing-title"},"Bài viết của bạn"),t("p",{class:"writing-subtitle"},"Luyện tập viết đoạn văn và nhận phản hồi tự động.")],-1)),t("div",ct,[e[2]||(e[2]=t("label",{class:"writing-label",for:"writing-title"},"Tiêu đề",-1)),U(t("input",{id:"writing-title","onUpdate:modelValue":e[0]||(e[0]=c=>i.value=c),type:"text",class:"writing-input",placeholder:"Ví dụ: Bữa ăn yêu thích của tôi",disabled:u.value},null,8,dt),[[R,i.value]])]),t("div",ut,[t("div",vt,[e[3]||(e[3]=t("label",{class:"writing-label",for:"writing-content"},"Nội dung",-1)),t("span",ht,d(I.value)+" ký tự",1)]),U(t("textarea",{id:"writing-content",ref_key:"textareaRef",ref:l,"onUpdate:modelValue":e[1]||(e[1]=c=>a.value=c),class:"writing-textarea",placeholder:"Hãy viết đoạn văn của bạn...",rows:"6",onInput:j,disabled:u.value},null,40,_t),[[R,a.value]])]),t("div",ft,[t("button",{type:"button",class:"writing-btn writing-btn--secondary",onClick:V,disabled:u.value&&!v.value}," Viết bài mới ",8,gt),t("button",{type:"submit",class:"writing-btn",disabled:!A.value},[u.value?(_(),h("span",mt,"Đang chấm điểm...")):(_(),h("span",wt,"Gửi đánh giá"))],8,pt)]),b(F,{name:"fade"},{default:C(()=>[f.value?(_(),h("p",yt,[q(d(f.value)+" ",1),t("button",{type:"button",class:"writing-error__retry",onClick:E,disabled:u.value}," Thử lại ",8,bt)])):T("",!0)]),_:1})],32),b(F,{name:"fade"},{default:C(()=>[v.value?(_(),h("section",kt,[t("header",St,[t("div",null,[t("h2",null,d(v.value.title||"Chưa có tiêu đề"),1),t("p",It,d(N(v.value.createdAt))+" • "+d(v.value.charCount)+" ký tự ",1)]),t("span",xt,"Điểm: "+d(v.value.score)+"/10",1)]),t("article",Ct,[e[5]||(e[5]=t("h3",null,"Nội dung",-1)),t("p",Tt,d(v.value.content),1)]),t("aside",At,[e[6]||(e[6]=t("h3",null,"Phản hồi",-1)),t("p",null,d(v.value.feedback),1)])])):T("",!0)]),_:1})]),t("aside",Nt,[e[7]||(e[7]=t("header",{class:"writing-history__header"},[t("h2",null,"Lịch sử bài viết"),t("p",null,"Theo dõi tiến bộ của bạn qua từng lần luyện tập.")],-1)),b(J,{name:"list-fade",tag:"ul",class:"writing-history__list"},{default:C(()=>[(_(!0),h(K,null,P(B(o),c=>(_(),h("li",{key:c.id},[t("button",{type:"button",class:Y(["history-item",{"history-item--active":c.id===r.value}]),onClick:m=>H(c.id)},[t("div",null,[t("p",Et,d(c.title||"Chưa có tiêu đề"),1),t("p",Dt,d(N(c.createdAt)),1)]),t("span",Ut,d(c.score)+"/10",1)],10,Vt)]))),128))]),_:1}),B(o).length?T("",!0):(_(),h("p",Rt," Chưa có bài viết nào. Hãy bắt đầu với đoạn văn đầu tiên! "))])])]))}}),Ht=X(Bt,[["__scopeId","data-v-b15018d6"]]);export{Ht as default};
