import{d as et,b as s,n as W,e as n,k as ie,A as Pt,m as be,F as q,i as Z,t as w,g as x,j as i,_ as tt,r as d,a as Le,c as K,q as $e,o as Vt,u as It,B as Dt,p as Ze,l as Qe,w as _e,f as se,v as Pe,C as Bt,D as Ut,T as Et,s as O,h as Xe,y as zt}from"./index-CblIsNI7.js";import{h as Rt,c as Ft,d as jt,e as Gt,f as Je,g as Ht,P as Ot,s as qt,i as Wt}from"./localStorage-gGBUY11W.js";import{A as Ye}from"./config-DlK2M2UR.js";const Kt={class:"sidebar__top"},Zt=["aria-label"],Qt={class:"sidebar__nav"},Xt={class:"sidebar__section"},Jt={key:0,class:"history__empty"},Yt={key:1,class:"history"},en=["title","onClick"],tn={class:"history__title"},nn={class:"history__meta"},on={key:0,class:"history__preview"},an=["onClick"],sn={class:"sidebar__account"},ln={class:"btn__label"},rn=et({__name:"Sidebar",props:{collapsed:{type:Boolean},conversations:{},activeId:{},userName:{}},emits:["toggle","new-chat","select","delete","clear-all","open-account"],setup(U,{emit:we}){const C=we,N=A=>new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"}).format(new Date(A)),M=A=>{confirm("Xác nhận xoá cuộc trò chuyện này?")&&C("delete",A)},f=()=>{C("open-account")};return(A,c)=>{const V=Pt("router-link");return i(),s("aside",{class:W(["sidebar",{"sidebar--collapsed":U.collapsed}])},[n("div",Kt,[c[3]||(c[3]=n("div",{class:"sidebar__brand"},[n("div",{class:"brand__icon"},"EC"),n("div",{class:"brand__text"},[n("strong",null,"AI Tutor"),n("span",null,"Gia sư tiếng Anh")])],-1)),n("button",{class:"sidebar__toggle",type:"button","aria-label":U.collapsed?"Mở thanh bên":"Thu gọn thanh bên",onClick:c[0]||(c[0]=S=>C("toggle"))},[...c[2]||(c[2]=[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},[n("rect",{x:"3",y:"4",width:"4",height:"16",rx:"1"}),n("rect",{x:"9",y:"6",width:"12",height:"4",rx:"1"}),n("rect",{x:"9",y:"14",width:"12",height:"4",rx:"1"})],-1)])],8,Zt)]),n("button",{class:"sidebar__new",type:"button",title:"Tạo cuộc trò chuyện mới","aria-label":"Tạo cuộc trò chuyện mới",onClick:c[1]||(c[1]=S=>C("new-chat"))},[...c[4]||(c[4]=[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},[n("path",{d:"M12 5v14M5 12h14","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1),n("span",{class:"sidebar__new-label"},"Cuộc trò chuyện mới",-1)])]),n("nav",Qt,[c[8]||(c[8]=n("p",{class:"sidebar__title"},"Liên kết nhanh",-1)),ie(V,{to:"/chat",class:"nav__link",title:"Trò chuyện"},{default:be(()=>[...c[5]||(c[5]=[n("span",{class:"nav__icon"},[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},[n("path",{d:"M4 6h16v9H7l-3 3z","stroke-width":"1.6","stroke-linejoin":"round"})])],-1),n("span",{class:"nav__label"},"Trò chuyện",-1)])]),_:1}),ie(V,{to:"/dictionary",class:"nav__link",title:"Từ điển"},{default:be(()=>[...c[6]||(c[6]=[n("span",{class:"nav__icon"},[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},[n("path",{d:"M5 4h12a3 3 0 0 1 3 3v13l-4-3-4 3-4-3-4 3V7a3 3 0 0 1 3-3z","stroke-width":"1.6","stroke-linejoin":"round"})])],-1),n("span",{class:"nav__label"},"Từ điển",-1)])]),_:1}),ie(V,{to:"/assignment",class:"nav__link",title:"Bài tập"},{default:be(()=>[...c[7]||(c[7]=[n("span",{class:"nav__icon"},[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},[n("path",{d:"M4 5h16v3H4zM4 11h10v3H4zM4 17h7v3H4z"})])],-1),n("span",{class:"nav__label"},"Bài tập",-1)])]),_:1})]),n("section",Xt,[c[11]||(c[11]=n("div",{class:"section__header"},[n("p",{class:"section__title"},"Lịch sử trò chuyện")],-1)),U.conversations.length?(i(),s("div",Yt,[(i(!0),s(q,null,Z(U.conversations,S=>(i(),s("div",{key:S.id,class:W(["history__item",{"history__item--active":S.id===U.activeId}])},[n("button",{class:"history__select",type:"button",title:`Mở cuộc trò chuyện ${S.title}`,onClick:Q=>C("select",S.id)},[n("span",tn,w(S.title),1),n("span",nn,w(N(S.updatedAt)),1),S.preview?(i(),s("span",on,w(S.preview),1)):x("",!0)],8,en),n("button",{class:"history__delete",type:"button",title:"Xóa cuộc trò chuyện","aria-label":"Xóa cuộc trò chuyện",onClick:Q=>M(S.id)},[...c[10]||(c[10]=[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon icon--sm"},[n("path",{d:"M6 7h12M10 11v6M14 11v6M9 7V5h6v2M7 7l1 12h8l1-12","stroke-width":"1.6","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])],8,an)],2))),128))])):(i(),s("div",Jt,[...c[9]||(c[9]=[n("p",null,"Chưa có cuộc trò chuyện nào.",-1)])]))]),n("div",sn,[c[13]||(c[13]=n("p",{class:"section__title"},"Tài khoản",-1)),n("button",{class:"btn btn--account",type:"button",title:"Cập nhật thông tin tài khoản",onClick:f},[c[12]||(c[12]=n("span",{class:"btn__icon"},[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},[n("path",{d:"M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-3.31 0-6 2.13-6 4.76V20h12v-1.24C18 16.13 15.31 14 12 14z"})])],-1)),n("span",ln,w(U.userName||"Bạn học"),1)])])],2)}}}),cn=tt(rn,[["__scopeId","data-v-fab05e77"]]),un={key:0,class:"mobile-navbar"},dn={class:"chat-main"},vn={key:0,class:"conversation__banner"},pn={key:1,class:"welcome","aria-live":"polite"},fn={class:"welcome__card"},hn={class:"welcome__text"},mn={class:"bubble__header"},gn={class:"bubble__meta"},yn=["onClick"],_n={class:"bubble__text"},bn=["onClick"],wn={key:1,class:"bubble__token bubble__token--text"},kn={key:2,class:"typing","aria-live":"polite"},Cn={class:"vocab-popover__header"},xn={class:"vocab-popover__title"},Mn=["title","aria-label","disabled"],An={class:"vocab-popover__body"},Sn={key:0,class:"vocab-popover__status"},Nn={key:1,class:"vocab-popover__status vocab-popover__status--error"},Tn=["innerHTML"],Ln=["disabled","onKeydown"],$n={class:"composer__tools"},Pn=["title","aria-label","aria-pressed"],Vn={key:0,viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},In={key:1,viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},Dn={key:1,class:"audio-wave","aria-hidden":"true"},Bn=["title","aria-label","disabled"],Un={key:0,viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},En={key:1,viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},zn={key:0,class:"suggestions","aria-live":"polite"},Rn=["onClick"],Fn={class:"account-modal"},jn={class:"account-modal__field"},Gn={key:0,class:"account-modal__error"},Hn={class:"account-modal__field"},On={key:0,class:"account-modal__error"},qn={class:"account-modal__field"},Wn=["value"],Kn={key:0,class:"account-modal__error"},Zn={class:"account-modal__field"},Qn=5e3,Xn=et({__name:"ChatView",setup(U){const we=It(),C=d([]),N=d(""),M=d(""),f=d(!1),A=d(""),c=d(!1),V=d(null),S=d(null),Q=d(!1),p=Le({fullName:"",age:"",proficiencyLevel:"",voicePreference:""}),m=Le({fullName:"",age:"",proficiencyLevel:""}),ke=d(""),Ce=d(""),nt=Ot,P=d(!1),_=d(!1),le=d(!1),xe=d(""),re=d(null);let T=null;const ce=d(null),Me=d([]),ue=d(!1),X=d(null),de=d(!1),ve=d([0,0,0,0,0]);let E=null,z=null,R=null,J=null,Y=null,I=1;const Ve=d([0,0,0,0,0]);let ot=[.018,.015,.02,.016,.017];const u=Le({visible:!1,keyword:"",loading:!1,error:"",content:"",top:0,left:0}),ee=d(!1),F=d(!1),at=K(()=>u.visible?{top:`${u.top}px`,left:`${u.left}px`}:{}),st=e=>{const t=e.split(/\n{2,}/).map(o=>o.trim()).filter(Boolean);return t.length?`<div>${t.map(o=>`<p>${o.replace(/\n/g,"<br />")}</p>`).join("")}</div>`:""},it=K(()=>u.content?st(u.content):""),pe=()=>{if(!u.visible)return;const e=V.value,t=S.value;if(!e||!t)return;const o=e.scrollLeft,a=e.clientWidth,l=t.offsetWidth,r=12;if(a<=0)return;let v;const k=o+r+l/2,b=o+a-r-l/2;b<=k?v=o+a/2:v=Math.min(Math.max(u.left,k),b),Math.abs(v-u.left)>.5&&(u.left=v)};let L=null;const fe=()=>{ee.value&&(typeof window>"u"||!("speechSynthesis"in window)||(window.speechSynthesis.cancel(),F.value=!1))},lt=()=>{L&&(L.abort(),L=null),fe(),u.visible=!1,u.loading=!1,u.error="",u.content=""},rt=()=>{if(!ee.value||!u.keyword.trim()||typeof window>"u"||!window.speechSynthesis)return;fe();const e=new SpeechSynthesisUtterance(u.keyword);e.lang="en-US",e.rate=.95,e.pitch=1,e.onstart=()=>{F.value=!0},e.onend=()=>{F.value=!1},e.onerror=()=>{F.value=!1},window.speechSynthesis.speak(e)},ct=async(e,t)=>{const o=e.trim();if(!o)return;const a=V.value,l=t.currentTarget;if(!a||!l)return;const r=a.getBoundingClientRect(),v=l.getBoundingClientRect(),k=v.bottom-r.top+a.scrollTop+8,b=v.left-r.left+a.scrollLeft+v.width/2;L&&L.abort(),fe();const $=new AbortController;L=$,u.visible=!0,u.keyword=o,u.loading=!0,u.error="",u.content="",u.top=k,u.left=b,await O(),pe();try{const h=await fetch(`${Ye}/api/dictionary/translate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:o}),signal:$.signal});if(!h.ok)throw new Error(await h.text());const g=(await h.json()).translatedText.trim();g?(u.content=g,u.error=""):(u.content="",u.error="Không tìm thấy nội dung phù hợp."),await O(),pe()}catch(h){if(h.name==="AbortError")return;console.error("Không thể tra cứu từ",h),u.content="",u.error=h instanceof Error?h.message:"Không thể tra cứu, vui lòng thử lại.",await O(),pe()}finally{L===$&&(u.loading=!1,L=null,await O(),pe())}},Ie=["Hi there! What would you like to learn today","Hello! Ask me anything in English","Ready to practice English Start with a question","Let’s chat in English What’s on your mind","Need help with grammar or vocabulary I’m here","Say hi and tell me your goal today","Ask me to explain, translate, or practice","We can role-play a conversation Start anytime","Tell me a topic you enjoy and we’ll chat","Type your first question to begin"],De=()=>Ie[Math.floor(Math.random()*Ie.length)],Be=d(De()),ut=/[\p{L}\p{M}\d]+(?:[-'’][\p{L}\p{M}\d]+)*/gu,dt=e=>{if(!e)return[];const t=[];let o=0;for(const a of e.matchAll(ut)){const l=a.index??0;l>o&&t.push({type:"text",display:e.slice(o,l)});const r=a[0];t.push({type:"word",display:r,lookup:r.trim().toLowerCase()}),o=l+r.length}return o<e.length&&t.push({type:"text",display:e.slice(o)}),t},he=(e=[])=>{const t=Date.now();return{id:crypto.randomUUID(),title:"New conversation",messages:e,createdAt:t,updatedAt:t}},vt=e=>{const t=[...e.messages].reverse().find(a=>a.content.trim().length);if(!t)return"";const o=t.content.replace(/\s+/g," ").trim();return o.length>60?`${o.slice(0,60)}...`:o},Ue=K(()=>C.value.find(e=>e.id===N.value)??null),te=K(()=>{var e;return((e=Ue.value)==null?void 0:e.messages)??[]}),Ae=K(()=>M.value.trim().length>0),Se=d(!1),pt=()=>{Se.value=!0},ft=()=>{Se.value=!1},ht=e=>{Se.value||f.value||M.value.trim()&&(e.preventDefault(),ae())},mt=K(()=>C.value.map(e=>({id:e.id,title:e.title,updatedAt:e.updatedAt,preview:vt(e)}))),gt=e=>{if(!e)return"New conversation";let o=e.replace(/\s+/g," ").trim();if(o=o.replace(/https?:\/\/\S+/gi,"").trim(),o=o.replace(/\[(.*?)\]\((.*?)\)/g,"$1").replace(/[`*_>#]/g,"").trim(),o=o.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,"").trim(),!o)return"New conversation";const a=o.match(/[^.!?。？！…]+[.!?。？！…]?/g)||[o];let r=(a.find(H=>/[?？]$/.test(H.trim()))||a[0]||o).trim();const v=r.split(/[,:;\-–—]/)[0].trim();v&&v.split(" ").length>=2&&(r=v);const h=r.replace(/^(cho (mình|em) hỏi|mình muốn hỏi|hãy|làm ơn|bạn có thể|vui lòng|could you|can you|would you)\s+/i,"").replace(/^[:\-\s]+/,"").trim().replace(/^['"“”‘’`\(\[]+|['"“”‘’`\)\]]+$/g,"").replace(/[.!?。？！…]+$/,"").replace(/[\.,!\?;:、。，．！？：；…\-–—\(\)\[\]\{\}'"“”‘’]/g,"").replace(/\s+/g," ").trim();return h?h.length>32?`${h.slice(0,32)}...`:h:"New conversation"},yt=e=>[...e].sort((t,o)=>o.updatedAt-t.updatedAt),j=e=>{const t=yt(e);C.value=t,Gt(t),Je(N.value)},G=e=>{N.value=e,Je(e),O(()=>Ne())},Ne=()=>{window.requestAnimationFrame(()=>{const e=V.value;e&&(e.scrollTop=e.scrollHeight)})};$e(te,()=>{O(()=>Ne())},{deep:!0}),$e(N,()=>{O(()=>Ne())});const Ee=()=>{var o;const e=Ht();ke.value=((o=e.fullName)==null?void 0:o.trim())??"";const t=typeof e.voicePreference=="string"&&e.voicePreference.trim()?e.voicePreference:typeof e.gender=="string"?e.gender:"";return Ce.value=typeof t=="string"?t.trim().toLowerCase():"",e},Te=()=>{m.fullName="",m.age="",m.proficiencyLevel=""},_t=()=>{const e=Ee();p.fullName=e.fullName??"",p.age=typeof e.age=="number"&&!Number.isNaN(e.age)?String(e.age):"",p.proficiencyLevel=typeof e.proficiencyLevel=="number"&&!Number.isNaN(e.proficiencyLevel)?String(e.proficiencyLevel):"",p.voicePreference=e.voicePreference??"",Te()},bt=()=>{_t(),Q.value=!0},me=()=>{Q.value=!1,Te()},wt=()=>{Te();const e=p.fullName.trim();e.length<2&&(m.fullName="Vui lòng nhập tên hợp lệ");const t=Number.parseInt(p.age,10);p.age?Number.isNaN(t)?m.age="Tuổi không hợp lệ":(t<7||t>60)&&(m.age="Tuổi phải nằm trong khoảng 7 đến 60"):m.age="Vui lòng nhập tuổi";const o=Number.parseInt(p.proficiencyLevel,10);if(p.proficiencyLevel?Number.isNaN(o)&&(m.proficiencyLevel="Cấp độ không hợp lệ"):m.proficiencyLevel="Vui lòng chọn cấp độ",m.fullName||m.age||m.proficiencyLevel)return;const a=p.voicePreference.trim(),l=a.toLowerCase();qt({fullName:e,age:t,proficiencyLevel:o,voicePreference:a||void 0}),ke.value=e,Ce.value=l,p.fullName=e,p.age=String(t),p.proficiencyLevel=String(o),p.voicePreference=a,X.value=null,Re(),me()},ze=()=>{c.value=!c.value},Re=()=>{if(typeof window>"u")return null;const e=window.speechSynthesis,t=()=>{const o=e.getVoices();if(!o||!o.length)return null;const a=Ce.value.trim().toLowerCase(),l=o.filter(g=>/en/i.test(g.lang)),r=a?l.find(g=>g.name.toLowerCase()===a):null;if(r)return r;const v=/female|girl|woman|zira|aria|salli|lisa|jenny|joanna|amy|olivia|emma|victoria|susan|linda|michelle/i,k=/male|boy|man|david|guy|brian|justin|matthew|adam|arthur|james|john|paul|ryan|michael|stephen|daniel/i,b=a&&(/^male$|^nam$|^man$|^anh$/i.test(a)||k.test(a)),$=a&&(/^female$|^nu$|^nữ$|^woman$|^chi$/i.test(a)||v.test(a));if(b&&!$){const g=l.find(D=>k.test(D.name));if(g)return g}if($&&!b){const g=l.find(D=>v.test(D.name));if(g)return g}const h=l.find(g=>v.test(g.name)),H=l.find(g=>k.test(g.name));return h??H??l[0]??o[0]??null};if(!X.value){const o=t();o?X.value=o:window.speechSynthesis.onvoiceschanged=()=>{const a=t();a&&(X.value=a)}}return X.value},Fe=()=>{try{window.speechSynthesis.cancel()}catch{}ue.value=!1},je=e=>{if(typeof window>"u"||!("speechSynthesis"in window)){console.info("[TTS] speechSynthesis not supported");return}Fe();const t=Re(),o=new SpeechSynthesisUtterance(e.content);o.lang="en-US",t&&(o.voice=t),o.rate=1,o.pitch=1,o.onstart=()=>{if(ue.value=!0,P.value)try{oe()}catch{}},o.onend=()=>{if(ue.value=!1,P.value&&!f.value&&!_.value)try{ne()}catch{}},o.onerror=()=>ue.value=!1;try{window.speechSynthesis.speak(o)}catch(a){console.error("[TTS] speak failed",a)}},kt=()=>{if(typeof window>"u")return null;const e=window,t=e.SpeechRecognition||e.webkitSpeechRecognition;if(!t)return xe.value="Trình duyệt không hỗ trợ nhận dạng giọng nói.",null;if(!re.value){const o=new t;o.lang="en-US",o.continuous=!0,o.interimResults=!0,o.onstart=()=>{_.value=!0,xe.value="";try{Oe()}catch{}},o.onend=()=>{_.value=!1;try{qe()}catch{}if(le.value){le.value=!1;return}if(P.value&&!f.value)try{ne()}catch{}},o.onerror=a=>{_.value=!1,xe.value=a!=null&&a.error?String(a.error):"Lỗi ghi âm"},o.onresult=a=>{let l="";for(let r=a.resultIndex;r<a.results.length;r++)l+=a.results[r][0].transcript;if(M.value=l.trim(),P.value){if(T!==null){try{clearTimeout(T)}catch{}T=null}T=window.setTimeout(()=>{if(T=null,!(!P.value||f.value||!M.value.trim())){try{oe()}catch{}ae()}},Qn)}},re.value=o}return re.value},ne=()=>{const e=kt();if(e){if(le.value=!1,T!==null){try{clearTimeout(T)}catch{}T=null}try{Oe()}catch{}try{e.start()}catch{}}},oe=(e=!1)=>{const t=re.value;if(e&&(le.value=!0),T!==null){try{clearTimeout(T)}catch{}T=null}if(t&&_.value)try{t.stop()}catch{}try{qe()}catch{}},Ct=()=>{if(P.value=!P.value,P.value){if(!f.value&&!_.value)try{ne()}catch{}}else try{oe()}catch{}},xt=e=>{f.value||(M.value=e,ae())},Ge=()=>{A.value="",M.value="";const e=he();j([e,...C.value]),G(e.id)},He=e=>{const t=N.value;if(!t)return;const o=C.value.map(a=>{if(a.id!==t)return a;const l=[...a.messages,e],v=!a.messages.some(k=>k.sender==="user")&&e.sender==="user"?gt(e.content):a.title;return{...a,title:v,messages:l,updatedAt:e.timestamp}});j(o)},Mt=()=>{Ue.value||Ge()},ae=async()=>{const e=M.value.trim();if(!e||f.value)return;Mt();try{oe()}catch{}const t=te.value.map(a=>({role:a.sender==="user"?"user":"assistant",content:a.content}));M.value="",A.value="";const o={id:crypto.randomUUID(),content:e,sender:"user",timestamp:Date.now()};He(o),f.value=!0;try{const a=new AbortController;ce.value=a;const l=await fetch(`${Ye}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",accept:"application/json"},body:JSON.stringify({message:e,history:t}),signal:a.signal});if(!l.ok)throw new Error(await l.text());const r=await l.json(),v={id:crypto.randomUUID(),content:r.reply,sender:"ai",timestamp:Date.now()};He(v);const k=b=>{const $=["Could you give me an example?","Can you explain it in simpler terms?","How can I practice this more?"],h=b.replace(/[^a-zA-Z ]/g,"").trim();return h&&$.unshift(`Can we discuss more about "${h.split(" ").slice(-3).join(" ")}"?`),Array.from(new Set($)).filter(Boolean).slice(0,4)};Me.value=Array.isArray(r.followUpQuestions)&&r.followUpQuestions.length?r.followUpQuestions.slice(0,4):k(e);try{je(v)}catch{}}catch(a){console.error("Cannot send message",a),((a==null?void 0:a.name)??"")!=="AbortError"&&(A.value=a instanceof Error?a.message:"May chu dang ban, vui long thu lai sau.")}finally{f.value=!1,ce.value=null}},At=()=>{const e=ce.value;if(e)try{e.abort()}catch{}try{Fe()}catch{}if(f.value=!1,ce.value=null,P.value&&!_.value)try{ne()}catch{}},St=e=>{const t=C.value.filter(o=>o.id!==e);if(!t.length){const o=he();j([o]),G(o.id),A.value="",M.value="";return}j(t),N.value===e&&G(t[0].id),A.value=""},Nt=()=>{Wt();const e=he();j([e]),G(e.id),M.value="",A.value=""},Tt=e=>{e!==N.value&&C.value.some(t=>t.id===e)&&(G(e),A.value="")},Lt=e=>new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"}).format(new Date(e));Vt(()=>{var o;if(Ee(),typeof window<"u"&&"speechSynthesis"in window?ee.value=!0:ee.value=!1,!Rt()){we.replace("/");return}const e=Ft(),t=jt();if(e.length){j(e);const a=((o=C.value[0])==null?void 0:o.id)??"";if(a){const l=C.value.some(r=>r.id===t);G(l?t:a)}}else{const a=he();j([a]),G(a.id)}}),Dt(()=>{fe(),L&&(L.abort(),L=null)}),$e(()=>[N.value,te.value.length],([,e])=>{e===0&&(Be.value=De())});const Oe=async()=>{var e;try{if(typeof window>"u")return;const t=window.AudioContext||window.webkitAudioContext;if(!t||!((e=navigator.mediaDevices)!=null&&e.getUserMedia))return;Y=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:!1}),E=new t;try{await E.resume()}catch{}const o=E.createMediaStreamSource(Y);z=E.createAnalyser(),z.fftSize=512,o.connect(z),R=new Uint8Array(z.fftSize),de.value=!0;const a=()=>{if(!z||!R)return;z.getByteTimeDomainData(R);let l=0;for(let y=0;y<R.length;y++){const B=R[y]-128;l+=B*B}let r=Math.min(1,Math.sqrt(l/R.length)/18);const v=.45,k=r*I;k<v?I=Math.min(4,I*1.02):k>.7?I=Math.max(1,I*.995):I=Math.max(1,I*.999),r=Math.min(1,Math.pow(r*I,.65)*1.2);const b=Ve.value.slice();for(let y=0;y<b.length;y++)b[y]+=ot[y],b[y]>Math.PI*2&&(b[y]-=Math.PI*2);Ve.value=b;const h=[1,1.35,1.75,1.35,1.1].map((y,B)=>{const ge=.85+.15*Math.sin(b[B]);return Math.max(0,Math.min(1,r*y*ge))}),H=[.5,.52,.48,.52,.5],g=[.93,.92,.94,.92,.93],D=.05,$t=ve.value.map((y,B)=>{const ge=h[B],We=ge>y?H[B]:g[B];let ye=y*We+ge*(1-We);const Ke=ye-y;return Ke>D?ye=y+D:Ke<-D&&(ye=y-D),ye});ve.value=$t,J=window.requestAnimationFrame(a)};J=window.requestAnimationFrame(a)}catch{de.value=!1}},qe=()=>{if(de.value=!1,J!=null){try{cancelAnimationFrame(J)}catch{}J=null}if(E){try{E.close()}catch{}E=null}if(Y){try{Y.getTracks().forEach(e=>e.stop())}catch{}Y=null}z=null,R=null};return(e,t)=>(i(),s("div",{class:W(["chat-screen",{"chat-screen--sidebar-collapsed":c.value}])},[ie(cn,{collapsed:c.value,conversations:mt.value,"active-id":N.value,"user-name":ke.value,onToggle:ze,onNewChat:Ge,onSelect:Tt,onDelete:St,onClearAll:Nt,onOpenAccount:bt},null,8,["collapsed","conversations","active-id","user-name"]),c.value?(i(),s("header",un,[t[8]||(t[8]=n("div",{class:"mobile-navbar__brand"},[n("span",{class:"brand__icon"},"EC"),n("strong",{class:"brand__text"},"AI Tutor")],-1)),n("button",{class:"mobile-navbar__toggle",type:"button","aria-label":"Mở thanh bên",onClick:ze},[...t[7]||(t[7]=[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},[n("rect",{x:"3",y:"4",width:"4",height:"16",rx:"1"}),n("rect",{x:"9",y:"6",width:"12",height:"4",rx:"1"}),n("rect",{x:"9",y:"14",width:"12",height:"4",rx:"1"})],-1)])])])):x("",!0),n("main",dn,[n("section",{class:"conversation",ref_key:"conversationRef",ref:V},[A.value?(i(),s("div",vn,w(A.value),1)):x("",!0),te.value.length===0?(i(),s("div",pn,[n("div",fn,[t[9]||(t[9]=n("h2",{class:"welcome__title"},"AI Tutor",-1)),n("p",hn,w(Be.value),1)])])):x("",!0),(i(!0),s(q,null,Z(te.value,o=>(i(),s("article",{key:o.id,class:W(["bubble",`bubble--${o.sender}`])},[n("div",mn,[n("span",gn,w(o.sender==="user"?"Bạn":"AI Tutor")+" - "+w(Lt(o.timestamp)),1),n("button",{class:"bubble__action",type:"button",title:"Phát lại đoạn hội thoại","aria-label":"Phát lại đoạn hội thoại",onClick:a=>je(o)},[...t[10]||(t[10]=[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon icon--sm"},[n("path",{d:"M8 5v14l11-7z",fill:"currentColor"})],-1)])],8,yn)]),n("p",_n,[(i(!0),s(q,null,Z(dt(o.content),(a,l)=>(i(),s(q,{key:`${o.id}-${l}`},[a.type==="word"?(i(),s("button",{key:0,type:"button",class:"bubble__token bubble__token--word",onClick:r=>ct(a.lookup??a.display,r)},w(a.display),9,bn)):(i(),s("span",wn,w(a.display),1))],64))),128))])],2))),128)),f.value?(i(),s("div",kn,[...t[11]||(t[11]=[n("span",{class:"typing__dot"},null,-1),n("span",{class:"typing__dot"},null,-1),n("span",{class:"typing__dot"},null,-1),Ze(" AI Tutor đang soạn câu trả lời... ",-1)])])):x("",!0),u.visible?(i(),s("div",{key:3,class:"vocab-popover",ref_key:"vocabPopoverRef",ref:S,style:Qe(at.value)},[n("header",Cn,[n("div",xn,[n("strong",null,w(u.keyword),1),ee.value?(i(),s("button",{key:0,type:"button",class:"vocab-popover__audio",title:F.value?"Đang phát...":"Phát âm","aria-label":F.value?"Đang phát":"Phát âm",disabled:F.value,onClick:rt},[...t[12]||(t[12]=[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon icon--sm"},[n("path",{d:"M5 9v6h3l4 4V5L8 9H5Zm11.5 3a2.5 2.5 0 0 0-1.5-2.296v4.592A2.5 2.5 0 0 0 16.5 12Zm-1.5-6.32v2.073A4.5 4.5 0 0 1 18.5 12a4.5 4.5 0 0 1-3.5 4.247v2.073A6.5 6.5 0 0 0 20.5 12 6.5 6.5 0 0 0 15 5.68Z",fill:"currentColor"})],-1)])],8,Mn)):x("",!0)]),n("button",{class:"vocab-popover__close",type:"button","aria-label":"Đóng giải nghĩa",onClick:lt},[...t[13]||(t[13]=[n("svg",{viewBox:"0 0 24 24","aria-hidden":"true",class:"icon"},[n("path",{d:"M6.225 4.811a1 1 0 0 0-1.414 1.414L10.586 12l-5.775 5.775a1 1 0 1 0 1.414 1.414L12 13.414l5.775 5.775a1 1 0 0 0 1.414-1.414L13.414 12l5.775-5.775a1 1 0 0 0-1.414-1.414L12 10.586Z",fill:"currentColor"})],-1)])])]),n("div",An,[u.loading?(i(),s("div",Sn,"Đang tra cứu...")):u.error?(i(),s("div",Nn,w(u.error),1)):(i(),s("div",{key:2,class:"vocab-popover__content",innerHTML:it.value},null,8,Tn))])],4)):x("",!0)],512),n("form",{class:"composer",onSubmit:_e(ae,["prevent"])},[n("div",{class:W(["composer__input",{"composer__input--listening":_.value}])},[se(n("textarea",{"onUpdate:modelValue":t[0]||(t[0]=o=>M.value=o),rows:"3",placeholder:"Nhập tin nhắn của bạn...",disabled:f.value,onKeydown:Bt(_e(ht,["exact"]),["enter"]),onCompositionstart:pt,onCompositionend:ft,required:""},null,40,Ln),[[Pe,M.value]]),n("div",$n,[n("button",{class:W(["icon-button",{"icon-button--recording":_.value}]),type:"button",title:_.value?"Dừng nghe":"Ghi âm giọng nói","aria-label":_.value?"Dừng nghe":"Ghi âm giọng nói","aria-pressed":_.value?"true":"false",onClick:t[1]||(t[1]=o=>_.value?oe(!0):ne())},[_.value?(i(),s("svg",In,[...t[15]||(t[15]=[n("rect",{x:"6",y:"6",width:"12",height:"12",rx:"2",fill:"#ffffff"},null,-1)])])):(i(),s("svg",Vn,[...t[14]||(t[14]=[n("path",{d:"M12 2a3 3 0 0 1 3 3v6a3 3 0 0 1-6 0V5a3 3 0 0 1 3-3zm-5 9a5 5 0 0 0 10 0h2a7 7 0 0 1-6 6.93V21h-2v-3.07A7 7 0 0 1 5 11h2z",fill:"currentColor"},null,-1)])]))],10,Pn),!Ae.value&&!_.value?(i(),s("button",{key:0,class:W(["icon-button auto-toggle",{"icon-button--primary":P.value}]),type:"button",title:"Chế độ tự động","aria-label":"Chế độ tự động",onClick:Ct},[...t[16]||(t[16]=[Ut('<svg viewBox="0 0 24 24" aria-hidden="true" class="icon" data-v-f7018c01><rect x="3" y="8" width="2" height="8" rx="1" fill="currentColor" data-v-f7018c01></rect><rect x="7" y="5" width="2" height="14" rx="1" fill="currentColor" data-v-f7018c01></rect><rect x="11" y="2" width="2" height="20" rx="1" fill="currentColor" data-v-f7018c01></rect><rect x="15" y="5" width="2" height="14" rx="1" fill="currentColor" data-v-f7018c01></rect><rect x="19" y="8" width="2" height="8" rx="1" fill="currentColor" data-v-f7018c01></rect></svg>',1)])],2)):x("",!0),_.value?(i(),s("div",Dn,[(i(),s(q,null,Z(5,o=>n("span",{key:o,class:"audio-wave__bar",style:Qe(de.value?{animation:"none",height:6+Math.round(ve.value[o-1]*12)+"px",opacity:.5+ve.value[o-1]*.5}:{animationDelay:o*.12+"s"})},null,4)),64))])):x("",!0),!_.value&&(f.value||Ae.value)?(i(),s("button",{key:2,class:"icon-button icon-button--primary",type:"button",title:f.value?"Dừng":"Gửi","aria-label":f.value?"Dừng":"Gửi",disabled:!f.value&&!Ae.value,onClick:t[2]||(t[2]=o=>f.value?At():ae())},[f.value?(i(),s("svg",Un,[...t[17]||(t[17]=[n("rect",{x:"6",y:"6",width:"12",height:"12",rx:"2",fill:"#ffffff"},null,-1)])])):(i(),s("svg",En,[...t[18]||(t[18]=[n("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z",fill:"#ffffff"},null,-1)])]))],8,Bn)):x("",!0)])],2),Me.value.length&&!f.value?(i(),s("div",zn,[(i(!0),s(q,null,Z(Me.value,(o,a)=>(i(),s("button",{key:a,type:"button",class:"suggestion-chip",onClick:l=>xt(o)},w(o),9,Rn))),128))])):x("",!0)],32)]),ie(Et,{name:"modal-fade"},{default:be(()=>[Q.value?(i(),s("div",{key:0,class:"account-modal__backdrop",role:"dialog","aria-modal":"true","aria-labelledby":"account-modal-title",onClick:_e(me,["self"])},[n("div",Fn,[n("header",{class:"account-modal__header"},[t[20]||(t[20]=n("h2",{id:"account-modal-title"},"Cập nhật thông tin",-1)),n("button",{class:"account-modal__close",type:"button","aria-label":"Đóng hộp thoại",onClick:me},[...t[19]||(t[19]=[n("span",{"aria-hidden":"true"},"X",-1)])])]),n("form",{class:"account-modal__form",onSubmit:_e(wt,["prevent"])},[n("div",jn,[t[21]||(t[21]=n("label",{class:"account-modal__label",for:"account-full-name"},"Tên",-1)),se(n("input",{id:"account-full-name",type:"text",class:"account-modal__input","onUpdate:modelValue":t[3]||(t[3]=o=>p.fullName=o),placeholder:"Nhập tên của bạn",autocomplete:"name"},null,512),[[Pe,p.fullName]]),m.fullName?(i(),s("p",Gn,w(m.fullName),1)):x("",!0)]),n("div",Hn,[t[22]||(t[22]=n("label",{class:"account-modal__label",for:"account-age"},"Tuổi",-1)),se(n("input",{id:"account-age",type:"number",class:"account-modal__input",min:"7",max:"60","onUpdate:modelValue":t[4]||(t[4]=o=>p.age=o),placeholder:"Nhập tuổi"},null,512),[[Pe,p.age]]),m.age?(i(),s("p",On,w(m.age),1)):x("",!0)]),n("div",qn,[t[24]||(t[24]=n("label",{class:"account-modal__label",for:"account-level"},"Cấp độ",-1)),se(n("select",{id:"account-level",class:"account-modal__input","onUpdate:modelValue":t[5]||(t[5]=o=>p.proficiencyLevel=o)},[t[23]||(t[23]=n("option",{value:""},"Chọn cấp độ",-1)),(i(!0),s(q,null,Z(zt(nt),o=>(i(),s("option",{key:o.id,value:o.id.toString()},w(o.name),9,Wn))),128))],512),[[Xe,p.proficiencyLevel]]),m.proficiencyLevel?(i(),s("p",Kn,w(m.proficiencyLevel),1)):x("",!0)]),n("div",Zn,[t[26]||(t[26]=n("label",{class:"account-modal__label",for:"account-voice"},[Ze(" Giọng đọc ưa thích "),n("small",{class:"account-modal__hint"}," (nhóm tiếng Anh - giọng mặc định: nữ) ")],-1)),se(n("select",{id:"account-voice",class:"account-modal__input","onUpdate:modelValue":t[6]||(t[6]=o=>p.voicePreference=o)},[...t[25]||(t[25]=[n("option",{value:""},"Tự động chọn",-1),n("option",{value:"female"},"Nữ (giọng Anh-Mỹ)",-1),n("option",{value:"male"},"Nam (giọng Anh-Mỹ)",-1),n("option",{value:"microsoft aria"},"Microsoft Aria (Female)",-1),n("option",{value:"microsoft zira"},"Microsoft Zira (Female)",-1),n("option",{value:"microsoft jenny"},"Microsoft Jenny (Female)",-1),n("option",{value:"microsoft guy"},"Microsoft Guy (Male)",-1),n("option",{value:"microsoft david"},"Microsoft David (Male)",-1)])],512),[[Xe,p.voicePreference]])]),n("div",{class:"account-modal__actions"},[n("button",{type:"button",class:"account-modal__button account-modal__button--ghost",onClick:me}," Huỷ "),t[27]||(t[27]=n("button",{type:"submit",class:"account-modal__button account-modal__button--primary"}," Lưu thay đổi ",-1))])],32)])])):x("",!0)]),_:1})],2))}}),to=tt(Xn,[["__scopeId","data-v-f7018c01"]]);export{to as default};
